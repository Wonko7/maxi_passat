(* This file was generated by Ocsigen Start.
   Feel free to use it, modify it, and redistribute it as you wish. *)

open Os_db

(* We are using PGOCaml to make type safe DB requests to Postgresql.
   The Makefile automatically compiles
   all files *_db.ml with PGOCaml's ppx syntax extension.
*)

let get () =
  full_transaction_block (fun dbh ->
      [%pgsql dbh "SELECT lastname FROM ocsigen_start.users"])

let obj_to_headline h =
  { Db_types.headline_id = h#headline_id
  ; parent_id = h#parent_id
  ; headline_text = h#headline_text
  ; headline_index = h#headline_index
  ; level = h#level
  ; content = h#content }

let get_headlines () =
  let%lwt hls =
    full_transaction_block (fun dbh ->
        [%pgsql.object
          dbh
            "SELECT h.headline_id, h.headline_index, h.level, hc.parent_id,
                    h.content, h.headline_text
             FROM org.headlines h, org.headline_closures hc
             WHERE outline_hash = '3db55aef08678059e115514d15a2db33'
               AND (hc.depth = 1 OR (hc.depth = 0 AND h.level = 1))
               AND h.headline_id = hc.headline_id
             ORDER BY level ASC, headline_index ASC"])
  in
  Lwt.return @@ List.map obj_to_headline hls
